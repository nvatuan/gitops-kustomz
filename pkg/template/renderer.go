package template

import (
	"bytes"
	"fmt"
	"os"
	"text/template"
)

// Renderer handles template rendering
type Renderer struct {
	funcMap template.FuncMap
}

// NewRenderer creates a new template renderer
func NewRenderer() *Renderer {
	return &Renderer{
		funcMap: template.FuncMap{
			"gt": func(a, b int) bool { return a > b },
		},
	}
}

// Render renders a template file with the provided data
func (r *Renderer) Render(templatePath string, data interface{}) (string, error) {
	// Read template file
	content, err := os.ReadFile(templatePath)
	if err != nil {
		return "", fmt.Errorf("failed to read template: %w", err)
	}

	return r.RenderString(string(content), data)
}

// RenderString renders a template string with the provided data
func (r *Renderer) RenderString(templateStr string, data interface{}) (string, error) {
	tmpl, err := template.New("template").Funcs(r.funcMap).Parse(templateStr)
	if err != nil {
		return "", fmt.Errorf("failed to parse template: %w", err)
	}

	var buf bytes.Buffer
	if err := tmpl.Execute(&buf, data); err != nil {
		return "", fmt.Errorf("failed to execute template: %w", err)
	}

	return buf.String(), nil
}

// GetDefaultCommentTemplate returns the default comment template
func (r *Renderer) GetDefaultCommentTemplate() string {
	return `<!-- gitops-kustomz: {{.Service}}-{{.Environment}} -->

# ğŸ” GitOps Policy Check: {{.Service}} ({{.Environment}})

**Base Commit:** ` + "`{{.BaseCommit}}`" + `
**Head Commit:** ` + "`{{.HeadCommit}}`" + `
**Timestamp:** {{.Timestamp}}

---

## ğŸ“Š Summary

{{if .Diff.HasChanges}}
âœï¸ **Changes detected in manifests** ({{.Diff.LineCount}} lines changed)
{{else}}
âœ… **No changes detected**
{{end}}

{{if .PolicyReport}}
**Policy Evaluation:**
- **Total:** {{.PolicyReport.TotalPolicies}}
- **Passed:** {{.PolicyReport.PassedPolicies}} âœ…
- **Failed:** {{.PolicyReport.FailedPolicies}} âŒ
{{if gt .PolicyReport.ErroredPolicies 0}}- **Errored:** {{.PolicyReport.ErroredPolicies}} âš ï¸{{end}}

{{if gt .PolicyReport.FailedPolicies 0}}**Failures by Level:**
{{if gt .PolicyReport.BlockingFailures 0}}- ğŸš« Blocking: {{.PolicyReport.BlockingFailures}}{{end}}
{{if gt .PolicyReport.WarningFailures 0}}- âš ï¸  Warning: {{.PolicyReport.WarningFailures}}{{end}}
{{if gt .PolicyReport.RecommendFailures 0}}- ğŸ’¡ Recommend: {{.PolicyReport.RecommendFailures}}{{end}}
{{end}}
{{end}}

---

## ğŸ“ Manifest Diff

{{if .Diff.HasChanges}}
{{if gt .Diff.LineCount 50}}
<details>
<summary>Click to expand diff ({{.Diff.LineCount}} lines)</summary>

` + "```diff" + `
{{.Diff.Content}}
` + "```" + `

</details>
{{else}}
` + "```diff" + `
{{.Diff.Content}}
` + "```" + `
{{end}}
{{else}}
_No changes detected between base and head._
{{end}}

---

## ğŸ›¡ï¸ Policy Evaluation Results

{{range .PolicyReport.Details}}
### {{.Name}} - {{.Status}} {{if .Overridden}}(Overridden){{end}}

**Level:** {{.Level}}

{{if eq .Status "ERROR"}}
âš ï¸ **Error:** {{.Error}}
{{else if eq .Status "FAIL"}}
{{if .Overridden}}
âœ‹ **Policy failed but was overridden**
{{else}}
âŒ **Policy violations:**
{{range .Violations}}
- {{.}}
{{end}}
{{end}}
{{else}}
âœ… **Passed**
{{end}}

---
{{end}}

---

_Generated by [gitops-kustomz](https://github.com/gh-nvat/gitops-kustomz)_
`
}
