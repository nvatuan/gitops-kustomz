<!-- gitops-kustomz: {{.Service}}-{{.Environment}} -->

# 🔍 GitOps Policy Check: {{.Service}} ({{.Environment}})

**Base Commit:** `{{.BaseCommit}}`
**Head Commit:** `{{.HeadCommit}}`
**Timestamp:** {{.Timestamp}}

---

## 📊 Summary

{{if .Diff.HasChanges}}
✏️ **Changes detected in manifests** ({{.Diff.LineCount}} lines changed)
{{else}}
✅ **No changes detected**
{{end}}

{{if .PolicyReport}}
**Policy Evaluation:**
- **Total:** {{.PolicyReport.TotalPolicies}}
- **Passed:** {{.PolicyReport.PassedPolicies}} ✅
- **Failed:** {{.PolicyReport.FailedPolicies}} ❌
{{if gt .PolicyReport.ErroredPolicies 0}}- **Errored:** {{.PolicyReport.ErroredPolicies}} ⚠️{{end}}

{{if gt .PolicyReport.FailedPolicies 0}}**Failures by Level:**
{{if gt .PolicyReport.BlockingFailures 0}}- 🚫 Blocking: {{.PolicyReport.BlockingFailures}}{{end}}
{{if gt .PolicyReport.WarningFailures 0}}- ⚠️  Warning: {{.PolicyReport.WarningFailures}}{{end}}
{{if gt .PolicyReport.RecommendFailures 0}}- 💡 Recommend: {{.PolicyReport.RecommendFailures}}{{end}}
{{end}}
{{end}}

---

## 📝 Manifest Diff

{{if .Diff.HasChanges}}
{{if gt .Diff.LineCount 50}}
<details>
<summary>Click to expand diff ({{.Diff.LineCount}} lines)</summary>

```diff
{{.Diff.Content}}
```

</details>
{{else}}
```diff
{{.Diff.Content}}
```
{{end}}
{{else}}
_No changes detected between base and head._
{{end}}

---

## 🛡️ Policy Evaluation Results

{{range .PolicyReport.Details}}
### {{.Name}} - {{.Status}} {{if .Overridden}}(Overridden){{end}}

**Level:** {{.Level}}

{{if eq .Status "ERROR"}}
⚠️ **Error:** {{.Error}}
{{else if eq .Status "FAIL"}}
{{if .Overridden}}
✋ **Policy failed but was overridden**
{{else}}
❌ **Policy violations:**
{{range .Violations}}
- {{.}}
{{end}}
{{end}}
{{else}}
✅ **Passed**
{{end}}

---
{{end}}

---

_Generated by [gitops-kustomz](https://github.com/gh-nvat/gitops-kustomz)_

